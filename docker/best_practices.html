<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.31" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://leiping520.github.io/docs/docker/best_practices.html"><meta property="og:site_name" content="悟空"><meta property="og:description" content="本附录是笔者对 Docker 官方文档中 Best practices for writing Dockerfiles的理解与翻译 一般性的指南和建议 容器应该是短暂的 通过Dockerfile构建的镜像所启动的容器应该尽可能短暂（生命周期短）。短暂意味着可以停止和销毁容器，并且创建一个新容器并部署好所需的设置和配置工作量应该是极小的。 使用.dock..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-15T09:32:04.000Z"><meta property="article:author" content="George"><meta property="article:modified_time" content="2024-03-15T09:32:04.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"","image":[""],"dateModified":"2024-03-15T09:32:04.000Z","author":[{"@type":"Person","name":"George","url":"https://leiping520.github.io/docs/"}]}</script><title>悟空</title><meta name="description" content="本附录是笔者对 Docker 官方文档中 Best practices for writing Dockerfiles的理解与翻译 一般性的指南和建议 容器应该是短暂的 通过Dockerfile构建的镜像所启动的容器应该尽可能短暂（生命周期短）。短暂意味着可以停止和销毁容器，并且创建一个新容器并部署好所需的设置和配置工作量应该是极小的。 使用.dock...">
    <link rel="preload" href="/docs/assets/style-BTVRClrK.css" as="style"><link rel="stylesheet" href="/docs/assets/style-BTVRClrK.css">
    <link rel="modulepreload" href="/docs/assets/app-DRadftDd.js"><link rel="modulepreload" href="/docs/assets/best_practices.html-zd_WHOH0.js"><link rel="modulepreload" href="/docs/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/docs/assets/markdown.html-CjQ1zyPt.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Bdw-VMCa.js" as="script"><link rel="prefetch" href="/docs/assets/disable.html-tgjHWSq9.js" as="script"><link rel="prefetch" href="/docs/assets/encrypt.html-BXQZNAq7.js" as="script"><link rel="prefetch" href="/docs/assets/layout.html-BAE7MsL9.js" as="script"><link rel="prefetch" href="/docs/assets/markdown.html-B111Qsp2.js" as="script"><link rel="prefetch" href="/docs/assets/page.html-DXU7rqbv.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-HdGY5qe-.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BbHDqUrc.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DTSpoLDp.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-B6Bz_SVY.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BcZ5hEZk.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CzUAKo_q.js" as="script"><link rel="prefetch" href="/docs/assets/dockerfile.html-D1Hu0agf.js" as="script"><link rel="prefetch" href="/docs/assets/add.html-CKZZXKKB.js" as="script"><link rel="prefetch" href="/docs/assets/cmd.html-C33QXA93.js" as="script"><link rel="prefetch" href="/docs/assets/copy.html-Bz7fX4x0.js" as="script"><link rel="prefetch" href="/docs/assets/entrypoint.html-FPhWD8Nv.js" as="script"><link rel="prefetch" href="/docs/assets/env.html-Bn-Hj9N2.js" as="script"><link rel="prefetch" href="/docs/assets/expose.html-Ug_weJb8.js" as="script"><link rel="prefetch" href="/docs/assets/laravel.html-CDHzU4_Y.js" as="script"><link rel="prefetch" href="/docs/assets/multistage_build.html-DvigttAr.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-C3U0QSUO.js" as="script"><link rel="prefetch" href="/docs/assets/shell.html-CFYtpuFI.js" as="script"><link rel="prefetch" href="/docs/assets/user.html-7G0xoJWw.js" as="script"><link rel="prefetch" href="/docs/assets/volume.html-Bn3vg0KL.js" as="script"><link rel="prefetch" href="/docs/assets/workdir.html-BbyoKcNu.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-uxHIyYll.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-D3eTg2zg.js" as="script"><link rel="prefetch" href="/docs/assets/disable.html-B8VPhAJy.js" as="script"><link rel="prefetch" href="/docs/assets/encrypt.html-DHnWVi7n.js" as="script"><link rel="prefetch" href="/docs/assets/layout.html-C6e336XS.js" as="script"><link rel="prefetch" href="/docs/assets/markdown.html-DI1_nTRe.js" as="script"><link rel="prefetch" href="/docs/assets/page.html-C39mgBc3.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DrTWvkrm.js" as="script"><link rel="prefetch" href="/docs/assets/cherry.html-DS_St6fj.js" as="script"><link rel="prefetch" href="/docs/assets/dragonfruit.html-acMWoW4f.js" as="script"><link rel="prefetch" href="/docs/assets/strawberry.html-C42k7FFi.js" as="script"><link rel="prefetch" href="/docs/assets/tomato.html-BW_lKrDZ.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-00iuq8l5.js" as="script"><link rel="prefetch" href="/docs/assets/any.html-CpvCSfbz.js" as="script"><link rel="prefetch" href="/docs/assets/generics.html-BMJ05eYL.js" as="script"><link rel="prefetch" href="/docs/assets/intro.html-Co_QSgge.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-D51zTnqY.js" as="script"><link rel="prefetch" href="/docs/assets/tsc.html-13hXOupk.js" as="script"><link rel="prefetch" href="/docs/assets/types.html-BCdyUZ9j.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Cnc-TNGF.js" as="script"><link rel="prefetch" href="/docs/assets/1.html-CdWsWt2Q.js" as="script"><link rel="prefetch" href="/docs/assets/2.html-B_haex8Y.js" as="script"><link rel="prefetch" href="/docs/assets/3.html-B3lJcdXh.js" as="script"><link rel="prefetch" href="/docs/assets/4.html-BaKk3K1d.js" as="script"><link rel="prefetch" href="/docs/assets/1.html-chyBwv4p.js" as="script"><link rel="prefetch" href="/docs/assets/2.html-CnZGmBhu.js" as="script"><link rel="prefetch" href="/docs/assets/3.html-CazKnBI4.js" as="script"><link rel="prefetch" href="/docs/assets/4.html-fAc7n27J.js" as="script"><link rel="prefetch" href="/docs/assets/404.html-D1UQY6lC.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DckCyrAx.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Bk4TdiJo.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CNTmBdTF.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BbguzXRG.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-0DcwHFjl.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BJQiYRQ7.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CHkxaEhG.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CcHbQml8.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BzIRyEQ5.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Kd78H3yv.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Dqtbc_26.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-D7VDIf0G.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BCkKg2fP.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-kAcmPWkE.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BGE28b0W.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-B1voQT8T.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-e-UP21WA.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Den-z0jU.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DyNNGzn7.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DJgk5SwG.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-D5gI0SdN.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-B-6nkNx8.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DhjkYaeo.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-Bt3_dFGL.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-h3yN2tTr.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DVY6Yl-Q.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CF32ES8o.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BaiAFOO1.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CbthoWgI.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CneyQZqt.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-7yp65mZd.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CZ1SLlLl.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-D7-KdtaO.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BGPDJX1u.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-B5LqBUxB.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-BzNEfoSA.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-dDsWlz49.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-D_30V9mj.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-B4BSfPDD.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-lM2ZNsQH.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-CXrDya-G.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-fYhOtGkw.js" as="script"><link rel="prefetch" href="/docs/assets/index.html-DL3pZHzn.js" as="script"><link rel="prefetch" href="/docs/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/docs/"><img class="vp-nav-logo" src="/docs/logo.png" alt><!----><span class="vp-site-name hide-in-pad">悟空</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Docker"><span class="title"><span class="font-icon icon iconfont icon-docker" style=""></span>Docker</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/docs/docker/install/" aria-label="安装Docker"><span class="font-icon icon iconfont icon-install" style=""></span>安装Docker<!----></a></li><li class="dropdown-item"><a class="route-link nav-link active" href="/docs/docker/" aria-label="Docker入门"><span class="font-icon icon iconfont icon-ability" style=""></span>Docker入门<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/docs/docker/cases/" aria-label="Docker实战"><span class="font-icon icon iconfont icon-alias" style=""></span>Docker实战<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/docs/docker/cases/ci_cd/" aria-label="CI/CD"><span class="font-icon icon iconfont icon-ci" style=""></span>CI/CD<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/docs/docker/compose/" aria-label="Compose"><span class="font-icon icon iconfont icon-any" style=""></span>Compose<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/docs/docker/kubernetes/" aria-label="kubernetes"><span class="font-icon icon iconfont icon-build" style=""></span>kubernetes<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端相关"><span class="title"><span class="font-icon icon iconfont icon-front" style=""></span>前端相关</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/docs/frontend/jquery/" aria-label="JQuery"><span class="font-icon icon iconfont icon-jQuery" style=""></span>JQuery<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/docs/frontend/typescript/" aria-label="TypeScript"><span class="font-icon icon iconfont icon-typescript" style=""></span>TypeScript<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/docs/markdown.html" aria-label="MD 文档"><span class="font-icon icon iconfont icon-markdown" style=""></span>MD 文档<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><div class="nav-item"><div class="dropdown-wrapper i18n-dropdown"><button type="button" class="dropdown-title" aria-label="选择语言"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link active" href="/docs/docker/best_practices.html" aria-label="简体中文"><!---->简体中文<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/docs/en/" aria-label="English"><!---->English<!----></a></li></ul></button></div></div><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/leiping520/docs/" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/" aria-label="Docker 简介"><span class="font-icon icon iconfont icon-laptop-code" style=""></span>Docker 简介<!----></a></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon iconfont icon-book" style=""></span><span class="vp-sidebar-title">基本概念</span><!----></p><ul class="vp-sidebar-links"></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon iconfont icon-book" style=""></span><span class="vp-sidebar-title">使用镜像</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/images/dockerfile.html" aria-label="使用Dockerfile定制镜像"><span class="font-icon icon iconfont icon-book" style=""></span>使用Dockerfile定制镜像<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon iconfont icon-book" style=""></span><span class="vp-sidebar-title">Dockfile 文件</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/" aria-label="Dockfile指令详解"><span class="font-icon icon iconfont icon-mitten" style=""></span>Dockfile指令详解<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/copy.html" aria-label="COPY 复制文件"><span class="font-icon icon iconfont icon-copy" style=""></span>COPY 复制文件<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/add.html" aria-label="ADD 更高级的复制文件"><span class="font-icon icon iconfont icon-add" style=""></span>ADD 更高级的复制文件<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/cmd.html" aria-label="CMD 容器启动命令"><span class="font-icon icon iconfont icon-ability" style=""></span>CMD 容器启动命令<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/entrypoint.html" aria-label="ENTRYPOINT 入口点"><span class="font-icon icon iconfont icon-actions" style=""></span>ENTRYPOINT 入口点<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/env.html" aria-label="ENV 设置环境变量"><span class="font-icon icon iconfont icon-advance" style=""></span>ENV 设置环境变量<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/volume.html" aria-label="VOLUME 定义匿名卷"><span class="font-icon icon iconfont icon-mesh" style=""></span>VOLUME 定义匿名卷<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/expose.html" aria-label="EXPOSE 定义暴露的端口"><span class="font-icon icon iconfont icon-network" style=""></span>EXPOSE 定义暴露的端口<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/workdir.html" aria-label="WORKDIR 指定工作目录"><span class="font-icon icon iconfont icon-palette" style=""></span>WORKDIR 指定工作目录<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/user.html" aria-label="USER 指定当前用户"><span class="font-icon icon iconfont icon-profile" style=""></span>USER 指定当前用户<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/shell.html" aria-label="SHELL 指令"><span class="font-icon icon iconfont icon-others" style=""></span>SHELL 指令<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/multistage_build.html" aria-label="多阶段构建"><span class="font-icon icon iconfont icon-software" style=""></span>多阶段构建<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/docker/dockfile/laravel.html" aria-label="实战多阶段构建Laravel镜像"><span class="font-icon icon iconfont icon-valine" style=""></span>实战多阶段构建Laravel镜像<!----></a></li></ul></section></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/docs/docker/best_practices.html" aria-label="Dockerfile 最佳实践"><span class="font-icon icon iconfont icon-book" style=""></span>Dockerfile 最佳实践<!----></a></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!----></h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://leiping520.github.io/docs/" target="_blank" rel="noopener noreferrer">George</a></span><span property="author" content="George"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-08T09:32:12.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 10 分钟</span><meta property="timeRequired" content="PT10M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/docs/#一般性的指南和建议">一般性的指南和建议</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#容器应该是短暂的">容器应该是短暂的</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#使用-dockerignore文件">使用.dockerignore文件</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#使用多阶段构建">使用多阶段构建</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#避免安装不必要的包">避免安装不必要的包</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#一个容器只运行一个进程">一个容器只运行一个进程</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#镜像层数尽可能少">镜像层数尽可能少</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#将多行参数排序">将多行参数排序</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#构建缓存">构建缓存</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/docs/#dockerfile-指令">Dockerfile 指令</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#from">FROM</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#label">LABEL</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#run">RUN</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#env">ENV</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#add和copy">ADD和COPY</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/docs/#entrypoint">ENTRYPOINT</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><blockquote><p>本附录是笔者对 <code>Docker</code> 官方文档中 <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" target="_blank" rel="noopener noreferrer">Best practices for writing Dockerfiles<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>的理解与翻译</p></blockquote><h2 id="一般性的指南和建议" tabindex="-1"><a class="header-anchor" href="#一般性的指南和建议"><span>一般性的指南和建议</span></a></h2><h3 id="容器应该是短暂的" tabindex="-1"><a class="header-anchor" href="#容器应该是短暂的"><span>容器应该是短暂的</span></a></h3><p>通过<code>Dockerfile</code>构建的镜像所启动的容器应该尽可能短暂（生命周期短）。短暂意味着可以停止和销毁容器，并且创建一个新容器并部署好所需的设置和配置工作量应该是极小的。</p><h3 id="使用-dockerignore文件" tabindex="-1"><a class="header-anchor" href="#使用-dockerignore文件"><span>使用<code>.dockerignore</code>文件</span></a></h3><p>使用<code>Dockerfile</code>构建镜像时最好是将<code>Dockerfile</code>放置在一个新建的空目录中。然后将构建镜像所需的文件添加到该目录中。为了提高构建镜像的效率，你可以在目录下新建一个<code>.dockerignore</code>文件来指定要忽略的文件和目录。<code>.dockerignore</code>文件的格式与<code>git</code>的<code>.gitignore</code>文件的格式类似。</p><h3 id="使用多阶段构建" tabindex="-1"><a class="header-anchor" href="#使用多阶段构建"><span>使用多阶段构建</span></a></h3><p>在<code>Docker 17.05</code>以上版本中，你可以使用多阶段构建来减少构建镜像的大小。</p><h3 id="避免安装不必要的包" tabindex="-1"><a class="header-anchor" href="#避免安装不必要的包"><span>避免安装不必要的包</span></a></h3><p>为了降低复杂性、减少依赖、减少文件大小、节约构建时间，你应该避免安装任何不必要的包。例如，不要再数据库镜像中包含一个文本编辑器。</p><h3 id="一个容器只运行一个进程" tabindex="-1"><a class="header-anchor" href="#一个容器只运行一个进程"><span>一个容器只运行一个进程</span></a></h3><p>应该保证在一个容器中只运行一个进程。将多个应用解耦到不同容器中，保证了容器的横向扩展和复用。例如web应用应该包含三个容器：web应用容器、数据库容器和缓存容器。</p><p>如果容器互相依赖，你可以使用 <a class="route-link" href="/docs/docker/dockfile/cmd.html">Docker自定义网络</a> 来把这些容器连接起来。</p><h3 id="镜像层数尽可能少" tabindex="-1"><a class="header-anchor" href="#镜像层数尽可能少"><span>镜像层数尽可能少</span></a></h3><p>你需要在 <code>Dockerfile</code> 可读性（也包括长期的可维护性）和减少层数之间做一个平衡。</p><h3 id="将多行参数排序" tabindex="-1"><a class="header-anchor" href="#将多行参数排序"><span>将多行参数排序</span></a></h3><p>将多行参数按字母顺序排序（比如要安装多个包时）。这可以帮助你避免重复包含同一个包，更新包列表时也更容易。也便于 <code>PRs</code> 阅读和审查。建议在反斜杠符号 <code>\</code> 之前添加一个空格，以增加可读性。</p><p>下面是来自 <code>buildpack-deps</code> 镜像的例子：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>
  bzr <span class="token operator">\</span>
  cvs <span class="token operator">\</span>
  git <span class="token operator">\</span>
  mercurial <span class="token operator">\</span>
  subversion</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="构建缓存" tabindex="-1"><a class="header-anchor" href="#构建缓存"><span>构建缓存</span></a></h3><p>在镜像的构建过程中，<code>Docker</code> 会遍历 <code>Dockerfile</code> 文件中的指令，然后按顺序执行。在执行每条指令之前，<code>Docker</code> 都会在缓存中查找是否已经存在可重用的镜像，如果有就使用现存的镜像，不再重复创建。如果你不想在构建过程中使用缓存，你可以在 <code>docker build</code> 命令中使用 <code>--no-cache=true</code> 选项。</p><p>但是，如果你想在构建的过程中使用缓存，你得明白什么时候会，什么时候不会找到匹配的镜像，遵循的基本规则如下：</p><ul><li>从一个基础镜像开始（<code>FROM</code> 指令指定），下一条指令将和该基础镜像的所有子镜像进行匹配，检查这些子镜像被创建时使用的指令是否和被检查的指令完全一样。如果不是，则缓存失效。</li><li>在大多数情况下，只需要简单地对比 <code>Dockerfile</code> 中的指令和子镜像。然而，有些指令需要更多的检查和解释。</li><li>对于 <code>ADD</code> 和 <code>COPY</code> 指令，镜像中对应文件的内容也会被检查，每个文件都会计算出一个校验和。文件的最后修改时间和最后访问时间不会纳入校验。在缓存的查找过程中，会将这些校验和和已存在镜像中的文件校验和进行对比。如果文件有任何改变，比如内容和元数据，则缓存失效。</li><li>除了 <code>ADD</code> 和 <code>COPY</code> 指令，缓存匹配过程不会查看临时容器中的文件来决定缓存是否匹配。例如，当执行完 <code>RUN apt-get -y update</code> 指令后，容器中一些文件被更新，但 Docker 不会检查这些文件。这种情况下，只有指令字符串本身被用来匹配缓存。</li></ul><p>一旦缓存失效，所有后续的 <code>Dockerfile</code> 指令都将产生新的镜像，缓存不会被使用。</p><h2 id="dockerfile-指令" tabindex="-1"><a class="header-anchor" href="#dockerfile-指令"><span>Dockerfile 指令</span></a></h2><p>下面针对 <code>Dockerfile</code> 中各种指令的最佳编写方式给出建议。</p><h3 id="from" tabindex="-1"><a class="header-anchor" href="#from"><span>FROM</span></a></h3><p>尽可能使用当前官方仓库作为你构建镜像的基础。推荐使用 <a href="https://hub.docker.com/_/alpine/" target="_blank" rel="noopener noreferrer">Alpine<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>镜像，因为它被严格控制并保持最小尺寸（目前小于 5 MB），但它仍然是一个完整的发行版。</p><h3 id="label" tabindex="-1"><a class="header-anchor" href="#label"><span>LABEL</span></a></h3><p>你可以给镜像添加标签来帮助组织镜像、记录许可信息、辅助自动化构建等。每个标签一行，由 <code>LABEL</code> 开头加上一个或多个标签对。下面的示例展示了各种不同的可能格式。<code>#</code> 开头的行是注释内容。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>如果你的字符串中包含空格，必须将字符串放入引号中或者对空格使用转义。如果字符串内容本身就包含引号，必须对引号使用转义。</p></div><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token comment"># Set one or more individual labels</span>
<span class="token instruction"><span class="token keyword">LABEL</span> com.example.version=<span class="token string">&quot;0.0.1-beta&quot;</span></span>

<span class="token instruction"><span class="token keyword">LABEL</span> vendor=<span class="token string">&quot;ACME Incorporated&quot;</span></span>

<span class="token instruction"><span class="token keyword">LABEL</span> com.example.release-date=<span class="token string">&quot;2015-02-12&quot;</span></span>

<span class="token instruction"><span class="token keyword">LABEL</span> com.example.version.is-production=<span class="token string">&quot;&quot;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一个镜像可以包含多个标签，但建议将多个标签放入到一个 <code>LABEL</code> 指令中。</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token comment"># Set multiple labels at once, using line-continuation characters to break long lines</span>
<span class="token instruction"><span class="token keyword">LABEL</span> vendor=ACME\ Incorporated <span class="token operator">\</span>
      com.example.is-beta= <span class="token operator">\</span>
      com.example.is-production=<span class="token string">&quot;&quot;</span> <span class="token operator">\</span>
      com.example.version=<span class="token string">&quot;0.0.1-beta&quot;</span> <span class="token operator">\</span>
      com.example.release-date=<span class="token string">&quot;2015-02-12&quot;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="run" tabindex="-1"><a class="header-anchor" href="#run"><span>RUN</span></a></h3><p>为了保持 <code>Dockerfile</code> 文件的可读性，可理解性，以及可维护性，建议将长的或复杂的 <code>RUN</code> 指令用反斜杠 <code>\</code> 分割成多行。</p><h4 id="apt-get" tabindex="-1"><a class="header-anchor" href="#apt-get"><span>apt-get</span></a></h4><p><code>RUN</code> 指令最常见的用法是安装包用的 <code>apt-get</code>。因为 <code>RUN apt-get</code> 指令会安装包，所以有几个问题需要注意。</p><p>不要使用 <code>RUN apt-get upgrade</code> 或 <code>dist-upgrade</code>，因为许多基础镜像中的「必须」包不会在一个非特权容器中升级。如果基础镜像中的某个包过时了，你应该联系它的维护者。如果你确定某个特定的包，比如 <code>foo</code>，需要升级，使用 <code>apt-get install -y foo</code> 就行，该指令会自动升级 <code>foo</code> 包。</p><p>永远将 <code>RUN apt-get update</code> 和 <code>apt-get install</code> 组合成一条 <code>RUN</code> 声明，例如：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>
  package-bar <span class="token operator">\</span>
  package-baz <span class="token operator">\</span>
  package-foo</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 <code>apt-get update</code> 放在一条单独的 <code>RUN</code> 声明中会导致缓存问题以及后续的 <code>apt-get install</code> 失败。比如，假设你有一个 <code>Dockerfile</code> 文件：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:14.04</span>

<span class="token instruction"><span class="token keyword">RUN</span> apt-get update</span>

<span class="token instruction"><span class="token keyword">RUN</span> apt-get install -y curl</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构建镜像后，所有的层都在 <code>Docker</code> 的缓存中。假设你后来又修改了其中的 <code>apt-get install</code> 添加了一个包：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:18.04</span>

<span class="token instruction"><span class="token keyword">RUN</span> apt-get update</span>

<span class="token instruction"><span class="token keyword">RUN</span> apt-get install -y curl nginx</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Docker 发现修改后的 <code>RUN apt-get update</code> 指令和之前的完全一样。所以，<code>apt-get update</code> 不会执行，而是使用之前的缓存镜像。因为 <code>apt-get update</code> 没有运行，后面的 <code>apt-get install</code> 可能安装的是过时的 <code>curl</code> 和 <code>nginx</code> 版本。</p><p>使用 <code>RUN apt-get update &amp;&amp; apt-get install -y</code> 可以确保你的 <code>Dockerfiles</code> 每次安装的都是包的最新的版本，而且这个过程不需要进一步的编码或额外干预。这项技术叫作 <code>cache busting</code>。你也可以显示指定一个包的版本号来达到 <code>cache-busting</code>，这就是所谓的固定版本，例如：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>
    package-bar <span class="token operator">\</span>
    package-baz <span class="token operator">\</span>
    package-foo=1.3.*</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>固定版本会迫使构建过程检索特定的版本，而不管缓存中有什么。这项技术也可以减少因所需包中未预料到的变化而导致的失败。</p><p>下面是一个 <code>RUN</code> 指令的示例模板，展示了所有关于 <code>apt-get</code> 的建议。</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>
    aufs-tools <span class="token operator">\</span>
    automake <span class="token operator">\</span>
    build-essential <span class="token operator">\</span>
    curl <span class="token operator">\</span>
    dpkg-sig <span class="token operator">\</span>
    libcap-dev <span class="token operator">\</span>
    libsqlite3-dev <span class="token operator">\</span>
    mercurial <span class="token operator">\</span>
    reprepro <span class="token operator">\</span>
    ruby1.9.1 <span class="token operator">\</span>
    ruby1.9.1-dev <span class="token operator">\</span>
    s3cmd=1.1.* <span class="token operator">\</span>
 &amp;&amp; rm -rf /var/lib/apt/lists/*</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 <code>s3cmd</code> 指令指定了一个版本号 <code>1.1.*</code>。如果之前的镜像使用的是更旧的版本，指定新的版本会导致 <code>apt-get udpate</code> 缓存失效并确保安装的是新版本。</p><p>另外，清理掉 <code>apt</code> 缓存 <code>var/lib/apt/lists</code> 可以减小镜像大小。因为 <code>RUN</code> 指令的开头为 <code>apt-get udpate</code>，包缓存总是会在 <code>apt-get install</code> 之前刷新。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>官方的 <code>Debian</code> 和 <code>Ubuntu</code> 镜像会自动运行 <code>apt-get clean</code>，所以不需要显式的调用 <code>apt-get clean</code>。</p></div><h4 id="cmd" tabindex="-1"><a class="header-anchor" href="#cmd"><span>CMD</span></a></h4><p><code>CMD</code> 指令用于执行目标镜像中包含的软件，可以包含参数。<code>CMD</code> 大多数情况下都应该以 <code>CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;...]</code> 的形式使用。因此，如果创建镜像的目的是为了部署某个服务(比如 <code>Apache</code>)，你可能会执行类似于 <code>CMD [&quot;apache2&quot;, &quot;-DFOREGROUND&quot;]</code> 形式的命令。我们建议任何服务镜像都使用这种形式的命令。</p><p>多数情况下，<code>CMD</code> 都需要一个交互式的 <code>shell</code> (<code>bash</code>, <code>Python</code>, <code>perl</code> 等)，例如 <code>CMD [&quot;perl&quot;, &quot;-de0&quot;]</code>，或者 <code>CMD [&quot;PHP&quot;, &quot;-a&quot;]</code>。使用这种形式意味着，当你执行类似 <code>docker run -it python</code> 时，你会进入一个准备好的 <code>shell</code> 中。<code>CMD</code> 应该在极少的情况下才能以 <code>CMD [&quot;param&quot;, &quot;param&quot;]</code> 的形式与 <code>ENTRYPOINT</code> 协同使用，除非你和你的镜像使用者都对 <code>ENTRYPOINT</code> 的工作方式十分熟悉</p><h3 id="env" tabindex="-1"><a class="header-anchor" href="#env"><span>ENV</span></a></h3><p>为了方便新程序运行，你可以使用 <code>ENV</code> 来为容器中安装的程序更新 <code>PATH</code> 环境变量。例如使用 <code>ENV PATH /usr/local/nginx/bin:$PATH</code> 来确保 <code>CMD [&quot;nginx&quot;]</code> 能正确运行。</p><p><code>ENV</code> 指令也可用于为你想要容器化的服务提供必要的环境变量，比如 <code>Postgres</code> 需要的 <code>PGDATA</code>。</p><p>最后，<code>ENV</code> 也能用于设置常见的版本号，比如下面的示例：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">ENV</span> PG_MAJOR 9.3</span>

<span class="token instruction"><span class="token keyword">ENV</span> PG_VERSION 9.3.4</span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -SL http://example.com/postgres-<span class="token variable">$PG_VERSION</span>.tar.xz | tar -xJC /usr/src/postgress &amp;&amp; …</span>

<span class="token instruction"><span class="token keyword">ENV</span> PATH /usr/local/postgres-<span class="token variable">$PG_MAJOR</span>/bin:<span class="token variable">$PATH</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>类似于程序中的常量，这种方法可以让你只需改变 <code>ENV</code> 指令来自动的改变容器中的软件版本。</p><h3 id="add和copy" tabindex="-1"><a class="header-anchor" href="#add和copy"><span>ADD和COPY</span></a></h3><p>虽然 <code>ADD</code> 和 <code>COPY</code> 功能类似，但一般优先使用 <code>COPY</code>。因为它比 <code>ADD</code> 更透明。<code>COPY</code> 只支持简单将本地文件拷贝到容器中，而 <code>ADD</code> 有一些并不明显的功能（比如本地 <code>tar</code> 提取和远程 <code>URL</code> 支持）。因此，<code>ADD</code> 的最佳用例是将本地 <code>tar</code> 文件自动提取到镜像中，例如 <code>ADD rootfs.tar.xz</code>。</p><p>如果你的 <code>Dockerfile</code> 有多个步骤需要使用上下文中不同的文件。单独 <code>COPY</code> 每个文件，而不是一次性的 <code>COPY</code> 所有文件，这将保证每个步骤的构建缓存只在特定的文件变化时失效。例如：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">COPY</span> requirements.txt /tmp/</span>

<span class="token instruction"><span class="token keyword">RUN</span> pip install --requirement /tmp/requirements.txt</span>

<span class="token instruction"><span class="token keyword">COPY</span> . /tmp/</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果将 <code>COPY . /tmp/</code> 放置在 <code>RUN</code> 指令之前，只要 <code>.</code> 目录中任何一个文件变化，都会导致后续指令的缓存失效。</p><p>为了让镜像尽量小，最好不要使用 <code>ADD</code> 指令从远程 <code>URL</code> 获取包，而是使用 <code>curl</code> 和 <code>wget</code>。这样你可以在文件提取完之后删掉不再需要的文件来避免在镜像中额外添加一层。比如尽量避免下面的用法：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">ADD</span> http://example.com/big.tar.xz /usr/src/things/</span>

<span class="token instruction"><span class="token keyword">RUN</span> tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things</span>

<span class="token instruction"><span class="token keyword">RUN</span> make -C /usr/src/things all</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而是应该使用下面这种方法：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /usr/src/things <span class="token operator">\</span>
    &amp;&amp; curl -SL http://example.com/big.tar.xz <span class="token operator">\</span>
    | tar -xJC /usr/src/things <span class="token operator">\</span>
    &amp;&amp; make -C /usr/src/things all</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面使用的管道操作，所以没有中间文件需要删除。</p><p>对于其他不需要 <code>ADD</code> 的自动提取功能的文件或目录，你应该使用 <code>COPY</code>。</p><h3 id="entrypoint" tabindex="-1"><a class="header-anchor" href="#entrypoint"><span>ENTRYPOINT</span></a></h3></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/leiping520/docs//edit/main/src/docker/best_practices.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: leiping@yunxianginvest.com">George</span><!--]--><!--]--></div></div></footer><!----><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2024 George </div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/docs/assets/app-DRadftDd.js" defer></script>
  </body>
</html>
